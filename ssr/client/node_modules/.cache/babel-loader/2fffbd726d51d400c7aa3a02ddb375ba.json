{"ast":null,"code":"import _objectSpread from\"/Users/yaroslavudodov/Code/f4e/ssr/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/Users/yaroslavudodov/Code/f4e/ssr/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/yaroslavudodov/Code/f4e/ssr/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";/* eslint-disable no-invalid-this */import*as React from'react';import'./chat.scss';import ChatMessage from'./chat-message';import{connect}from'react-redux';import{addChatMessage,loadChatHistory}from'../../../ac/games';import _ from'lodash';import{withGameService}from'../../../HOCs';import{withNamespaces}from\"react-i18next\";/**\n * Game chat\n */class Chat extends React.Component{constructor(...args){var _this;super(...args);_this=this;this.maintainSocketMessages=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(socket){var _this$props,addChatMessage,loadChatHistory;return _regeneratorRuntime.wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:_this$props=_this.props,addChatMessage=_this$props.addChatMessage,loadChatHistory=_this$props.loadChatHistory;socket.on('*',message=>{console.log(message);switch(message.data[0]){case'GAME_CHAT_MESSAGE_HISTORY':loadChatHistory(message.data[1]);break;case'GAME_CHAT_MESSAGE_ADDED':addChatMessage(message.data[1]);break;default:break;}});case 2:case\"end\":return _context.stop();}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}();this.state={message:null};this.onChange=e=>{this.setState({[e.target.name]:e.target.value});};this.sendMessage=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(e){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:if(!(e.keyCode!==13)){_context2.next=2;break;}return _context2.abrupt(\"return\");case 2:if(!(e.target.value.trim()==='')){_context2.next=4;break;}return _context2.abrupt(\"return\");case 4:_context2.next=6;return _this.submit();case 6:case\"end\":return _context2.stop();}},_callee2);}));return function(_x2){return _ref2.apply(this,arguments);};}();}/**\n   * Init, handle socket messages\n   */componentDidMount(){var _this2=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var _this2$props,gameService,gameId;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:_this2$props=_this2.props,gameService=_this2$props.gameService,gameId=_this2$props.gameId;_context3.t0=_this2;_context3.next=4;return gameService.initChat(gameId);case 4:_context3.t1=_context3.sent;_context3.next=7;return _context3.t0.maintainSocketMessages.call(_context3.t0,_context3.t1);case 7:_context3.next=9;return gameService.getChatHistory(gameId);case 9:case\"end\":return _context3.stop();}},_callee3);}))();}componentWillUnmount(){const gameService=this.props.gameService;gameService.destroyChat();}/**\n   * @param {object} socket\n   * @return {Promise<void>}\n   */ /**\n   * Submit chat message\n   */submit(){var _this3=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){var _this3$props,gameService,gameId,t,_$pick,message;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:// @ts-ignore\ndocument.getElementById('message').value=null;_this3$props=_this3.props,gameService=_this3$props.gameService,gameId=_this3$props.gameId,t=_this3$props.t;_$pick=_.pick(_this3.state,['message']),message=_$pick.message;if(message){_context4.next=6;break;}alert('Нет смысла отправлять пустое сообщение');return _context4.abrupt(\"return\");case 6:_context4.prev=6;_context4.next=9;return gameService.addChatMessage(_objectSpread(_objectSpread({},_.pick(_this3.state,['message'])),{},{gameId}));case 9:_this3.setState({message:null});_context4.next=15;break;case 12:_context4.prev=12;_context4.t0=_context4[\"catch\"](6);if(_context4.t0.response.status>400&&_context4.t0.response.status<500){alert(t('Залогинтесь, для того чтобы послать сообщение в чат'));}case 15:case\"end\":return _context4.stop();}},_callee4,null,[[6,12]]);}))();}render(){const _this$props2=this.props,gameChat=_this$props2.gameChat,t=_this$props2.t;return/*#__PURE__*/React.createElement(\"div\",{className:\"chat\"},/*#__PURE__*/React.createElement(\"hr\",null),/*#__PURE__*/React.createElement(\"div\",{className:\"form-group\"},/*#__PURE__*/React.createElement(\"textarea\",{onChange:this.onChange,className:\"form-control\",name:\"message\",id:\"message\",onKeyUp:this.sendMessage}),/*#__PURE__*/React.createElement(\"br\",null),/*#__PURE__*/React.createElement(\"button\",{className:\"btn submit-btn mb-2 shadow-0\",onClick:this.submit.bind(this)},t('Послать сообщение'))),/*#__PURE__*/React.createElement(\"form\",null,/*#__PURE__*/React.createElement(\"ul\",null,gameChat.entities.valueSeq().map(it=>{return/*#__PURE__*/React.createElement(ChatMessage,{key:it.id,message:it});}))));}}export default connect(state=>{return{gameChat:state.gameChat};// @ts-ignore\n},{addChatMessage,loadChatHistory})(withGameService(withNamespaces()(Chat)));","map":{"version":3,"sources":["/Users/yaroslavudodov/Code/f4e/ssr/client/src/components/game/chat/chat.tsx"],"names":["React","ChatMessage","connect","addChatMessage","loadChatHistory","_","withGameService","withNamespaces","Chat","Component","maintainSocketMessages","socket","props","on","message","console","log","data","state","onChange","e","setState","target","name","value","sendMessage","keyCode","trim","submit","componentDidMount","gameService","gameId","initChat","getChatHistory","componentWillUnmount","destroyChat","document","getElementById","t","pick","alert","response","status","render","gameChat","bind","entities","valueSeq","map","it","id"],"mappings":"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","sourcesContent":["/* eslint-disable no-invalid-this */\nimport * as React from 'react';\nimport './chat.scss';\nimport ChatMessage from './chat-message';\nimport {connect} from 'react-redux';\nimport {addChatMessage, loadChatHistory} from '../../../ac/games';\nimport _ from 'lodash';\nimport {withGameService} from '../../../HOCs';\nimport {withNamespaces} from \"react-i18next\";\n\ninterface Props {\n  gameId: any,\n  addChatMessage: any,\n  loadChatHistory: any,\n  gameService: any,\n  gameChat: any,\n  t: any\n}\n\n/**\n * Game chat\n */\nclass Chat extends React.Component<Props> {\n  /**\n   * Init, handle socket messages\n   */\n  async componentDidMount() {\n    const {gameService, gameId} = this.props\n    await this.maintainSocketMessages(await gameService.initChat(gameId))\n    await gameService.getChatHistory(gameId)\n  }\n  componentWillUnmount(): void {\n    const {gameService} = this.props\n    gameService.destroyChat()\n  }\n\n  /**\n   * @param {object} socket\n   * @return {Promise<void>}\n   */\n  maintainSocketMessages = async (socket: any) => {\n    const {addChatMessage, loadChatHistory} = this.props;\n    socket.on('*', (message: any)=> {\n      console.log(message)\n      switch (message.data[0]) {\n        case 'GAME_CHAT_MESSAGE_HISTORY':\n          loadChatHistory(message.data[1])\n          break;\n        case 'GAME_CHAT_MESSAGE_ADDED':\n          addChatMessage(message.data[1])\n          break;\n        default:\n          break;\n      }\n    });\n  };\n  /**\n   * @type {{message: null}}\n   */\n  state = {\n    message: null,\n  };\n  /**\n   * Handle all simple text inputs\n   * @param {object} e\n   * @return {void}\n   */\n  onChange = (e: any) => {\n    this.setState({\n      [e.target.name]: e.target.value,\n    });\n  };\n  /**\n   * @param {Event} e\n   */\n  sendMessage = async (e: any) => {\n    if (e.keyCode !== 13) {\n      return\n    }\n    if (e.target.value.trim() === '') {\n      return\n    }\n    await this.submit()\n  };\n  /**\n   * Submit chat message\n   */\n  async submit() {\n    // @ts-ignore\n    document.getElementById('message').value = null\n    const {gameService, gameId, t} = this.props;\n    const {message} = _.pick(this.state, ['message']);\n    if (!message) {\n      alert('Нет смысла отправлять пустое сообщение');\n      return;\n    }\n    try {\n      await gameService.addChatMessage({\n        ..._.pick(this.state, ['message']),\n        gameId,\n      });\n      this.setState({\n        message: null,\n      });\n    } catch (error) {\n      if (error.response.status > 400 && error.response.status < 500) {\n        alert(t('Залогинтесь, для того чтобы послать сообщение в чат'));\n      }\n    }\n  }\n\n  render() {\n    const {gameChat, t} = this.props;\n    return (\n      <div className=\"chat\">\n        <hr/>\n        <div className=\"form-group\">\n          <textarea\n            onChange={this.onChange}\n            className=\"form-control\"\n            name=\"message\"\n            id=\"message\"\n            onKeyUp={this.sendMessage}\n          />\n          <br/>\n          <button\n            className=\"btn submit-btn mb-2 shadow-0\"\n            onClick={this.submit.bind(this)}>{t('Послать сообщение')}</button>\n        </div>\n        <form>\n          <ul>\n            {gameChat.entities.valueSeq().map(\n                (it: any) => {\n                  return <ChatMessage key={it.id} message={it} />\n                }\n            )}\n          </ul>\n        </form>\n      </div>\n    );\n  }\n}\n\n\nexport default connect((state: any) => {\n  return {\n    gameChat: state.gameChat,\n  };\n  // @ts-ignore\n}, {addChatMessage, loadChatHistory})(withGameService(withNamespaces()(Chat)));\n"]},"metadata":{},"sourceType":"module"}